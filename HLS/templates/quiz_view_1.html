{% extends "index.html" %}
{% load static %}
{% csrf_token %}
{% block content %}
    <div id="questions" class="col-md-12" style="visibility: hidden;">
        <div class="col-md-6" id="questions_div">
            <span id="question_heading"></span>
        </div>
        <div class="col-md-6" id="container"></div>
        <div class="choice col-md-6">
            A: <span id="choice_a"></span><br>
            B: <span id="choice_b"></span><br>
            C: <span id="choice_c"></span><br>
            D: <span id="choice_d"></span><br>
            <div id="correctdiv" style="visibility: hidden; background-color: #932933; color:white; text-align: center;">
                Correct Answer: <span id="correct" ></span>
            </div>
        </div>
    </div>
    <script>
        var results_dict = {};
        var questionNum = 0;
        var index = 0;
        var json_global = '';
        $.getJSON("api/v1/quizdata?quizname={{ quizname }}", function(json) {
            json_global = json;
        });
        function nextquestion(){
            questionNum++;
            var quiz_json = JSON.parse(json_global);
            $('#quest_button').attr('onclick', 'showCorrect()').html('Show Answer!');
            $('#correctdiv').css('visibility', 'hidden');
            $('#question_heading').html(quiz_json['questions'][questionNum]);
            $('#choice_a').html(quiz_json['answers'][questionNum]['choices'][0]);
            $('#choice_b').html(quiz_json['answers'][questionNum]['choices'][1]);
            $('#choice_c').html(quiz_json['answers'][questionNum]['choices'][2]);
            $('#choice_d').html(quiz_json['answers'][questionNum]['choices'][3]);
        }
    </script>

    <div id='quizbuttondiv' class="col-md-12">
        <div id="startquizbutton">
            <button id="startquiz" class="btn btn-primary btn-lg" onclick="start_polling(0);chart();" >Start Quiz!</button>
            <button id="stopquiz" class="btn btn-primary btn-lg" onclick="stop_polling(); post_data();" >Stop Quiz!</button>
            <button class="btn btn-primary btn-lg" onclick="nextquestion();" >Next question</button>
        </div>
    </div>
    <script>

        function start_polling(questionNum){
            $('#startquiz').prop('disabled', true);
            $('#stopquiz').prop('disabled', false);
            interval = setInterval(function () {
                $.when(
                        $.ajax({
                            type: "GET",
                            url: "api/v1/data",
                            success: function (response) {
                                response_json = JSON.parse(response);
                                node_data = response_json['node_data'];
                            }
                        }).then(function() {
                            results_dict['overall'] = JSON.stringify(response_json);
                            results_dict['question'+questionNum] = JSON.stringify(node_data);
                        }))
            }, 1000);}
    </script>


    <script src="{%  static "js/highcharts.js" %}"></script>
    <script src="{% static "js/exporting.js" %}"></script>

    <script>


{##}
{#        function showCorrect(){#}
{#            $('#correctdiv').css('visibility', 'visible');#}
{#            $('#correct').html(json_global[index]['correct']);#}
{#            $('#quest_button').attr('onclick', 'nextquestion()').html('Next Question!');#}
{#            index++;#}
{#            if(index > json_global.length -1){#}
{#                index = 0;#}
{#            }#}
{#        }#}
{##}
{#        function graph() {#}
{#            $('.linkssmall').before('<div class="col-md-12" style="text-align: center;"> \#}
{#            <div id="nextquestionbutton" style="visibility: hidden;"> \#}
{#                <button id="quest_button" class="btn btn-primary" onclick="showCorrect()" >Show Answer!</button> \#}
{#                </div> \#}
{#            </div>');#}
{#            $('#questions').css('visibility', 'visible');#}
{#            $('#nextquestionbutton').css('visibility', 'visible');#}
{#            $('#quizbuttondiv').css('visibility', 'hidden');#}
{#            nextquestion();#}
{#        }#}

        function chart() {
            interval;
            $('#questions').css('visibility', 'visible');

            Highcharts.setOptions({
                global: {
                    useUTC: false
                },
                plotOptions: {
                    column: {
                        colorByPoint: true
                    }
                },
                colors: [
                    '#932933',
                    '#00ED77',
                    '#2E3B7F',
                    '#FCF528'
                ]
            });

            $('#container').highcharts({
                chart: {
                    type: 'column',
                    animation: Highcharts.svg, // don't animate in old IE
                    marginRight: 100,
                    backgroundColor: '#F7F7CD',
                    events: {
                        load: function () {
                            // set up the updating of the chart each second
                            var series = this.series[0];
                            interval2 = setInterval(function () {
                                            var response_json = JSON.parse(results_dict["overall"]);
                                            series.setData([response_json['A'] , response_json['B'], response_json['C'], response_json['D']], true, false, true);
                            }, 1000);
                        }
                    }
                },

                title: {
                    text: '',
                    style:{
                        color: '#437341',
                        fontSize: '25px',
                        fontFamily: "teacher"
                    }
                },
                xAxis: {
                    labels: {
                        style:{
                            color: '#932933',
                            fontSize: '25px',
                            fontFamily: "teacher"
                        }
                    },
                    categories: [
                        'A',
                        'B',
                        'C',
                        'D',
                    ],
                },
                yAxis: {
                    title: {
                        style:{
                            color: '#932933',
                            fontSize: '25px',
                            fontFamily: "teacher"
                        },
                        text: ''
                    },
                    labels: {
                        style: {
                            color: '#437341',
                            fontSize: '25px',
                            fontFamily: "teacher"
                        }
                    },
                    allowDecimals: false,
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#808080'
                    }]
                },

                legend: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                series: [{
                    name: 'Choices',
                    data: []

                }]
            });
        }

    </script>
    <script>
        function stop_polling(){
            clearInterval(interval);
            clearInterval(interval2);
            $('#stopquiz').prop('disabled', true);
            $('#startquiz').prop('disabled', false);
        }

        function post_data(){

            $.ajax({
                url: "/api/v1/results_data",
                type: "POST",
                data: {myArray : results_dict}
            });
        }
    </script>

{% endblock %}
